<link rel="import" href="bower_components/polymer/polymer.html"/>
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html"/>
<script src="bower_components/d3/d3.min.js"></script>

<dom-module id="emh-d3-tree">
  <template>
    <style>
      :host {
      display: block;
      }
      .general {
      width: 100%;
      height: 95%;
      }
      .general > div {
      padding: 4px;
      margin: 12px;
      }
      .relative {
      @apply(--layout-relative);
      @apply(--layout-vertical);
      }
      .fit {
      @apply(--layout-fit);
      }
      svg {
      border-radius: 25px;
      background-color: var(--d3-force-test-background-color, #ddd);
      border: 2px solid var(--d3-force-test-border-color, #73AD21);
      padding: 5px; 
      }
      .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 3px;
      }
      
      .node text { font: 12px sans-serif; }
      
      .node--internal text {
      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
      }
      
      #polymerTree > g > path {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
      }
    </style>
    <div class="general">
      <div class="relative" style="height: 100%;">
        <svg height="100%" width="100%" id="polymerTree"></svg>
      </div>
    </div>
  </template>

  <script>
    Polymer({

      is: 'emh-d3-tree',

      properties: {
        margin: {top: 20, right: 90, bottom: 30, left: 90},
        tree: {
          type: Object,
          notify: true, 
          value:  {
            "name": "Top Level",
            "value": 10,
            "type": "black",
            "level": "red",
            "children": [
                {
                "name": "Level 2: A",
                "value": 15,
                "type": "grey",
                "level": "red",
                "children": [
                    {
                    "name": "Son of A",
                    "value": 5,
                    "type": "steelblue",
                    "level": "orange"
                    },
                    {
                    "name": "Daughter of A",
                    "value": 8,
                    "type": "steelblue",
                    "level": "red"
                    }
                ]
                },
                {
                "name": "Level 2: B",
                "value": 10,
                "type": "grey",
                "level": "green"
                }
            ]
          },
          observer: '_treeChanged'
        },
        selected_node: {
          type: Object,
          notify: true
        }
      },
      created: function() {
        console.log(this.localName + '#' + this.id + ' was created');
      },
      
      ready: function() {
        console.log(this.localName + '#' + this.id + ' has local DOM initialized');
      },
      
      attached: function() {
        console.log(this.localName + '#' + this.id + ' was attached');
        var aa = this.$.polymerTree.getBoundingClientRect();
        var svg_height = aa.height - 20 - 30;
        var svg_width = aa.width - 90 - 90;
        this.treemap = d3.tree().size([svg_height, svg_width]);
        if (this.treemap) {
          this.redraw();
        }
      },
      
      detached: function() {
      console.log(this.localName + '#' + this.id + ' was detached');
      },
      
      
      _treeChanged: function() {
        console.log(this.localName + '#' + this.id + ' tree data has changed');
        if (this.force) {
          redraw();
        }
      },
      
      redraw: function() {
        this.nodes = d3.hierarchy(this.tree, function(d) {
          return d.children;
        });
        function zoomed() {
        g.attr("transform", d3.event.transform);
        }
        this.nodes = this.treemap(this.nodes);
        var g = d3.select(this.$.polymerTree).append("g")
                .attr("transform",
                "translate(" + 90 + "," + 20 + ")")
                .call(d3.zoom()
                .scaleExtent([1 / 2, 4])
                .on("zoom", this.zoomed));
                
        // adds the links between the nodes
        var link = g.selectAll(".link")
                    .data( this.nodes.descendants().slice(1))
                    .enter().append("path")
                    .attr("class", "link")
                    .style("stroke", function(d) { return d.data.level; })
                    .style("fill", "none")
                    .attr("d", function(d) {
                        return "M" + d.y + "," + d.x
                        + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                        + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                        + " " + d.parent.y + "," + d.parent.x;
                    });
        
        // adds each node as a group
        var node = g.selectAll(".node")
                    .data(this.nodes.descendants())
                    .enter().append("g")
                    .attr("class", function(d) { 
                      return "node" + (d.children ? " node--internal" : " node--leaf"); 
                    })
                    .attr("transform", function(d) { 
                      return "translate(" + d.y + "," + d.x + ")"; 
                    });
        
        // adds symbols as nodes
        node.append("path")
            .style("stroke", function(d) { return d.data.type; })
            .style("fill", function(d) { return d.data.level; })
            .attr("d", d3.symbol()
            .size(function(d) { return d.data.value * 30; } )
            .type(function(d) { 
              if (d.data.value >= 9) { return d3.symbolCross; } 
              else if (d.data.value <= 9) { return d3.symbolDiamond;}
            }));
        
        // adds the text to the node
        node.append("text")
          .attr("dy", ".35em")
          .attr("x", function(d) { return d.children ? 
          (d.data.value + 4) * -1 : d.data.value + 4 })
          .style("text-anchor", function(d) { 
          return d.children ? "end" : "start"; })
          .text(function(d) { return d.data.name; });
      }
      
    });
  </script>
</dom-module>
