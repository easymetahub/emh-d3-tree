<link rel="import" href="bower_components/polymer/polymer.html"/>
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html"/>
<script src="bower_components/d3/d3.min.js"></script>

<dom-module id="emh-d3-tree">
  <template>
    <style>
      :host {
      display: block;
      }
      .general {
      width: 100%;
      height: 95%;
      }
      .general > div {
      padding: 4px;
      margin: 12px;
      }
      .relative {
      @apply(--layout-relative);
      @apply(--layout-vertical);
      }
      .fit {
      @apply(--layout-fit);
      }
      svg {
      border-radius: 25px;
      background-color: var(--d3-force-test-background-color, #ddd);
      border: 2px solid var(--d3-force-test-border-color, #73AD21);
      padding: 5px; 
      }
      .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 3px;
      }
      
      .node text { font: 12px sans-serif; }
      
      .node--internal text {
      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
      }
      
      #polymerTree > g > path {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
      }
    </style>
    <div class="general">
      <div class="relative" style="height: 100%;">
        <svg height="100%" width="100%" id="polymerTree">
          <defs>
            <filter id="drop-shadow" height="130%">
              <feGaussianBlur in="SourceAlpha" stdDeviation="5" result="blur"/>
              <feOffset in="blur" dx="5" dy="5" result="offsetBlur"/>
              <feMerge>
                <feMergeNode in="offsetBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
        </svg>
      </div>
    </div>
  </template>

  <script>
    var d3Polymer;
    
    function hasClass(el, className) {
      if (el.classList)
        return el.classList.contains(className)
      else
        return !!el.className.match(new RegExp('(\\s|^)' + className + '(\\s|$)'))
    }
    
    function addClass(el, className) {
      if (el.classList)
        el.classList.add(className)
      else if (!hasClass(el, className)) 
        el.className += " " + className
    }
    
    function removeClass(el, className) {
      if (el.classList)
        el.classList.remove(className)
      else if (hasClass(el, className)) {
        var reg = new RegExp('(\\s|^)' + className + '(\\s|$)')
        el.className=el.className.replace(reg, ' ')
      }
    }
    
    
    
    
    
    Polymer({

      is: 'emh-d3-tree',

      properties: {
        margin: {top: 20, right: 90, bottom: 30, left: 90},
        tree: {
          type: Object,
          notify: true, 
          value:  {
          "elementType": "xs:schema",
          "name": "/xsd/01-person.xsd",
          "x_size": 7,
          "y_size": 7,
          "_draw": "<circle class=\"nodeSequence\" cx=\"0\" cy=\"0\" r=\"2\" stroke=\"black\" stroke-width=\"1\" style=\"fill: lemonchiffon;\"><\/circle>",
            "displayType": "object",
            "opacity": 0.5,
            "parentSchema": false,
            "plainName": "/xsd/01-person.xsd",
            "namespaces": [
            {
            "prefix": "xs",
            "uri": "http://www.w3.org/2001/XMLSchema"
            },
            {
            "prefix": "xml",
            "uri": "http://www.w3.org/XML/1998/namespace"
            }
            ],
            "attributeFormDefault": "unqualified",
            "elementFormDefault": "unqualified",
            "children": [{
            "elementType": "xs:element",
            "x_size": 50,
            "y_size": 57.0666666666667,
            "_draw": "<rect x=\"0\" y=\"-15\" width=\"57.0666666666667\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">Person<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "documentation": ["An individual human being."],
              "name": "Person",
              "abstract": "false",
              "nillable": "false",
              "children": [{
              "elementType": "xs:sequence",
              "x_size": 67,
              "y_size": 67,
              "_draw": "<polygon points=\"1,-15 11,-25 51,-25 61,-15  61,15 51,25  11,25 1,15\" fill=\"lightblue\" stroke=\"black\"><\/polygon><circle fill=\"black\" r=\"5\" cx=\"16\" cy=\"0\"/><circle fill=\"black\" r=\"5\" cx=\"31\" cy=\"0\"/><circle fill=\"black\" r=\"5\" cx=\"46\" cy=\"0\"/><line x1=\"1\" y1=\"0\" x2=\"60\" y2=\"0\" stroke=\"black\"/>",
              "children": [
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 114.2,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"114.2\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PersonGivenName<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "documentation": ["The name given to a person at birth.  In western countries this is usually the first name.  "],
              "name": "PersonGivenName",
              "minOccurs": "0",
              "maxOccurs": "1",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 120.933333333333,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"120.933333333333\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PersonFamilyName<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "name": "PersonFamilyName",
              "minOccurs": "1",
              "maxOccurs": "1",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 119.333333333333,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"119.333333333333\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PersonGenderCode<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "name": "PersonGenderCode",
              "minOccurs": "0",
              "maxOccurs": "1",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 110.133333333333,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"110.133333333333\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PersonBirthDate<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "name": "PersonBirthDate",
              "minOccurs": "0",
              "maxOccurs": "1",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 158.733333333333,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"158.733333333333\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PersonLikesSVGIndicator<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "name": "PersonLikesSVGIndicator",
              "minOccurs": "0",
              "maxOccurs": "1",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 92.2666666666667,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"92.2666666666667\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">PhoneNumber<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "name": "PhoneNumber",
              "maxOccurs": "unbounded",
              "minOccurs": "0",
              "nillable": "false"
              },
              {
              "elementType": "xs:element",
              "x_size": 50,
              "y_size": 48.6666666666667,
              "_draw": "<rect x=\"0\" y=\"-15\" width=\"48.6666666666667\" height=\"30\" style=\"fill: lemonchiffon\" stroke=\"#a07508\" stroke-width=\"1.5px\"><\/rect><text x=\"5\" y=\"0\" font-family=\"sans-serif\" font-size=\"10px\" text-anchor=\"start\">Email<\/text><text x=\"5\" y=\"12\" font-family=\"sans-serif\" font-size=\"8px\" text-anchor=\"start\"><\/text>",
              "displayType": "object",
              "maxOccurs": "unbounded",
              "name": "Email",
              "minOccurs": "1",
              "nillable": "false"
              }
              ]
              }]
              }]
              },
          observer: '_treeChanged'
        },
        selectedNode: {
          type: Object,
          notify: true
        }
      },
      created: function() {
        console.log(this.localName + '#' + this.id + ' was created');
      },
      
      ready: function() {
        console.log(this.localName + '#' + this.id + ' has local DOM initialized');
      },
      
      attached: function() {
        console.log(this.localName + '#' + this.id + ' was attached');
        d3Polymer = this;
        var aa = this.$.polymerTree.getBoundingClientRect();
        var svg_height = aa.height - 20 - 30;
        var svg_width = aa.width - 90 - 90;
        this.treemap = d3.tree()
                         .nodeSize([50, 120])
                         .separation(function(a, b) {return 1;});
                         
        if (this.treemap) {
          this.redraw();
        }
      },
      
      detached: function() {
        console.log(this.localName + '#' + this.id + ' was detached');
      },
      
      
      _treeChanged: function() {
        console.log(this.localName + '#' + this.id + ' tree data has changed');
        if (this.force) {
          redraw();
        }
      },
      
      redraw: function() {
        this.nodes = d3.hierarchy(this.tree, function(d) {
          return d.children;
        });
        function zoomed() {
        g.attr("transform", d3.event.transform);
        }
        this.nodes = this.treemap(this.nodes);
        var g = d3.select(this.$.polymerTree)        .call(d3.zoom()            .
        scaleExtent([.5, 10])
        .on("zoom", function () {
        g.attr("transform", d3.event.transform)
        }))
        .append("g")
                .attr("transform",
                "translate(" + 50 + "," + this.$.polymerTree.getBoundingClientRect().height / 2 + ")")
;
                
        // adds the links between the nodes
        var link = g.selectAll(".link")
                    .data( this.nodes.descendants().slice(1))
                    .enter().append("path")
                    .attr("class", "link emh-d3-tree")
                    .style("stroke", "#666")
                    .style("fill", "none")
                    .attr("d", function(d) {
                      return 'M' + (d.parent.y + 0) + ',' + d.parent.x +
                      'H' + (d.y - 30) + 'V' + d.x +
                      ('h' + 30);
                    });
        
        // adds each node as a group
        var node = g.selectAll(".node")
                    .data(this.nodes.descendants())
                    .enter().append("g")
                    .attr("class", function(d) { 
                      return "node emh-d3-tree" + (d.children ? " node--internal" : " node--leaf"); 
                    })
                    .attr("transform", function(d) { 
                      return "translate(" + d.y + "," + d.x + ")"; 
                    })
                    .on("click", 
                      function(d) { 
                        var previousOnes = document.getElementsByClassName("node_selected");
                        while (previousOnes.length) {
                          previousOnes[0].style.filter = null;
                          previousOnes[0].classList.remove("node_selected");
                        }
  
                        if (d == d3Polymer.selectedNode) {
                          d3Polymer.selectedNode = null;
                        } else {
                          d3Polymer.selectedNode = d; 
                          this.style.filter = "url(#drop-shadow)";
                          addClass(this, "node_selected");
                        }
                      }
                    )
                    ;
        
        // adds symbols as nodes
        node.html( function(d) { 
            return d.data._draw ? d.data._draw : ''; 
        });
        
        // adds the text to the node
        /*
        node.append("text")
          .attr("dy", ".35em")
          .attr("x", function(d) { return d.children ? 
          (d.data.value + 4) * -1 : d.data.value + 4 })
          .style("text-anchor", function(d) { 
          return d.children ? "end" : "start"; })
          .text(function(d) { return d.data.name; });
          */
      }
      
    });
  </script>
</dom-module>
